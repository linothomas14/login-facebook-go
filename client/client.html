<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Call</title>
  </head>
  <body>
    <h1>Client Login Facebook</h1>
    <button
      onclick="login('clientBRI','https://da1c-182-3-44-206.ngrok-free.app')"
    >
      Login Skema 1
    </button>
    <pre id="apiData"></pre>
    <pre id="sessionData"></pre>
    <button
      onclick="loginSchema2('clientBRI', 'https://da1c-182-3-44-206.ngrok-free.app')"
    >
      Login Skema 2
    </button>
    <button
      onclick="logout('clientBRI', 'https://da1c-182-3-44-206.ngrok-free.app')"
    >
      Logout
    </button>

    <script>
      function login(clientId, host) {
        const sessionCookie = getCookie("session");
        if (!sessionCookie) {
          const randomSession = generateRandomCookie("session", 32);
          window.open(
            `${host}/login-bento?client_id=${clientId}&session=${randomSession}`,
            "_blank"
          );
          window.location.reload();
        } else {
          document.getElementById("sessionData").textContent =
            "Session Cookie: " + sessionCookie;
          fetchAccessToken(clientId, sessionCookie, host);
        }
      }

      function loginSchema2(clientId, host) {
        const sessionCookie = getCookie("session");
        if (!sessionCookie) {
          const randomSession = generateRandomCookie("session", 32);
          window.open(
            `${host}/login-bento?client_id=${clientId}&session=${randomSession}`,
            "_blank"
          );
          window.location.reload();
        } else {
          fetch(
            `${host}/get-access-token?client_id=${clientId}&session=${sessionCookie}`
          )
            .then((response) => {
              if (response.ok) {
                return response.json();
              } else {
                throw new Error("Network response was not ok.");
              }
            })
            .then((data) => {
              window.open(
                `${host}/success-login?tokenJatis=${data.token}`,
                "_blank"
              );
            });
        }
      }

      function logout(clientId, host) {
        const sessionCookie = getCookie("session");
        if (sessionCookie) {
          fetchLogout(clientId, sessionCookie, host);
        }
      }

      function getCookie(name) {
        let cookieArray = document.cookie.split(";");
        for (let i = 0; i < cookieArray.length; i++) {
          let cookiePair = cookieArray[i].split("=");
          if (name === cookiePair[0].trim()) {
            return decodeURIComponent(cookiePair[1]);
          }
        }
        return null;
      }

      function setCookie(name, value, days) {
        var expires = "";
        if (days) {
          var date = new Date();
          date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
          expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
      }

      function generateRandomCookie(name, days) {
        const randomValue =
          Math.random().toString(36).substring(2, 15) +
          Math.random().toString(36).substring(2, 15);
        setCookie(name, randomValue, days);
        return randomValue;
      }

      function fetchAccessToken(clientId, session, host) {
        fetch(
          `${host}/get-access-token?client_id=${clientId}&session=${session}`
        )
          .then((response) => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error("Network response was not ok.");
            }
          })
          .then((data) => {
            document.getElementById("apiData").textContent =
              "Access Token: " + data.token;
          })
          .catch((error) => {
            document.getElementById("apiData").textContent =
              "Failed to fetch access";
          });
      }

      function fetchLogout(clientId, session, host) {
        deleteCookie("session");
        fetch(`${host}/logout?client_id=${clientId}&session=${session}`)
          .then((response) => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error("Network response was not ok.");
            }
          })
          .then((data) => {
            document.getElementById("apiData").textContent =
              "Successfully logout";
            window.location.reload();
          });
      }

      function deleteCookie(name) {
        document.cookie = name + "=; max-age=0; path=/"; // This sets the cookie's max-age to zero seconds, causing it to expire immediately
      }
    </script>
  </body>
</html>
