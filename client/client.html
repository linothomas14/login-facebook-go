<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Call</title>
  </head>
  <body>
    <h1>Client Login Facebook</h1>
    <button id="loginButton" onclick="login('clientBRI')">Login</button>
    <button id="logoutButton" onclick="logout('clientBRI')">Logout</button>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        updateButtonVisibility();
      });

      function updateButtonVisibility() {
        const sessionCookie = getCookie("session");
        const loginButton = document.getElementById("loginButton");
        const logoutButton = document.getElementById("logoutButton");

        if (sessionCookie) {
          loginButton.style.display = "none";
          logoutButton.style.display = "block";
        } else {
          loginButton.style.display = "block";
          logoutButton.style.display = "none";
        }
      }

      const HOST = "https://9ad9-180-251-181-137.ngrok-free.app";

      function login(clientId) {
        const sessionCookie = getCookie("session");
        if (!sessionCookie) {
          const randomSession = generateRandomCookie("session", 32);
          const loginUrl = `${HOST}/login-bento?client_id=${clientId}&session=${randomSession}`;
          window.open(loginUrl, "_blank");

          let attempts = 0;
          const maxAttempts = 10;
          const interval = setInterval(() => {
            if (attempts < maxAttempts) {
              fetchAccessToken(clientId, randomSession, interval); // Pass interval ID to possibly clear it
              attempts++;
            } else {
              clearInterval(interval);
              console.error(
                "Failed to fetch access token after maximum attempts."
              );
            }
          }, 5000); // Attempt every 5 seconds

          // Set a timeout to stop the fetch process after 30 seconds
          setTimeout(() => {
            clearInterval(interval);
            console.log("Process timed out after 30 seconds.");
          }, 30000); // 30 seconds timeout
        } else {
          fetchAccessToken(clientId, sessionCookie);
        }
      }

      function fetchAccessToken(clientId, session, intervalId = null) {
        fetch(
          `${HOST}/get-access-token?client_id=${clientId}&session=${session}`
        )
          .then((response) => {
            if (response.ok) {
              return response.json();
            } else if (response.status === 404) {
              return null;
            } else {
              throw new Error("Unexpected response status: " + response.status); // Handle other non-ok statuses by throwing an error
            }
          })
          .then((data) => {
            console.log("Access Token:", data.token);
            if (data.token != undefined) {
              setCookie("token", data.token, 32);
            }
            if (intervalId) clearInterval(intervalId);
          });
      }

      function logout(clientId, host) {
        const sessionCookie = getCookie("session");
        if (sessionCookie) {
          fetchLogout(clientId, sessionCookie, host);
        }
      }

      function getCookie(name) {
        let cookieArray = document.cookie.split(";");
        for (let i = 0; i < cookieArray.length; i++) {
          let cookiePair = cookieArray[i].split("=");
          if (name === cookiePair[0].trim()) {
            return decodeURIComponent(cookiePair[1]);
          }
        }
        return null;
      }

      function setCookie(name, value, days) {
        var expires = "";
        if (days) {
          var date = new Date();
          date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
          expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
      }

      function generateRandomCookie(name, days) {
        const randomValue =
          Math.random().toString(36).substring(2, 15) +
          Math.random().toString(36).substring(2, 15);
        setCookie(name, randomValue, days);
        return randomValue;
      }

      function fetchLogout(clientId, session) {
        deleteCookie("session");
        deleteCookie("token");
        fetch(`${HOST}/logout?client_id=${clientId}&session=${session}`)
          .then((response) => {
            if (response.ok) {
              return;
            }
          })
          .then((data) => {
            console.log("successfuly logout");
            window.location.reload();
          });
      }

      function deleteCookie(name) {
        document.cookie = name + "=; max-age=0; path=/"; // This sets the cookie's max-age to zero seconds, causing it to expire immediately
      }
    </script>
  </body>
</html>
